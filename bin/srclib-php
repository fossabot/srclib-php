#!/usr/bin/env node

var parser = require("nomnom");
var glob = require("glob");
var findpkgs = require("../lib/composer-findpackages");
var npm = require("npm");
var path = require("path");
var fs = require("fs");
var _ = require("underscore");

parser.command("scan")
  .option("repo", {
    help: "repository URI"
  })
  .option("subdir", {
    help: "subdirectory in repository"
  })
  .callback(function(opts) {
    //We are ignoring anything with the name "test" or "tests" in the path
    return findpkgs(".", ['test/', 'tests/'])
    .then(function scanComposerPackages(source_units) {
      if (!source_units || source_units.length < 1) {
        console.log(JSON.stringify([], null, 2));
        return;
      }

      // convert from composer-findpkgs format to source unit
      var srcunits = source_units.map(function(pkg) {
        return {
          Name: pkg.name,
          Type: "ComposerPackage",
          Dir: pkg.dir,
          Version: pkg.version,
          Files: pkg.files,
          Dependencies: pkg.dependencies,
          Ops: {depresolve: null, graph: null},
          Config: {}
        }
      })
      
      console.log(JSON.stringify(srcunits, null, 2));
    })
    .catch(function (err) {
      console.error("Error scanning composer packages: " + err)
      process.exit(1)
    })
  })
  .help("scan for Composer packages");

parser.parse();
